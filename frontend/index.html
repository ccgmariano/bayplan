<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BayPlan</title>
  <style>
    :root { font-family: Arial, Helvetica, sans-serif; }
    body { margin: 0; padding: 12px; background: #f6f7f8; }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; }
    h1 { margin: 0 0 8px 0; font-size: 18px; }

    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .section { margin-top: 10px; }

    label { font-size: 12px; color: #374151; }
    input, button {
      height: 36px; border-radius: 8px; border: 1px solid #d1d5db;
      padding: 0 10px; font-size: 14px; background: #fff;
    }
    button { cursor: pointer; }
    button.active { background: #111827; color: #fff; border-color: #111827; }
    button.small { height: 32px; font-size: 13px; padding: 0 12px; }
    .hint { margin-top: 6px; font-size: 12px; color: #6b7280; }
    .status { margin-top: 8px; font-size: 12px; color: #111827; }
    .status.error { color: #b91c1c; }
    .meta { margin-top: 6px; font-size: 12px; color: #374151; }

    .gridWrap { margin-top: 12px; overflow: auto; border-radius: 10px; border: 1px solid #e5e7eb; background: #fff; }
    table { border-collapse: collapse; width: max-content; min-width: 100%; }
    th, td { border: 1px solid #e5e7eb; padding: 6px; text-align: center; }
    th { position: sticky; top: 0; background: #f3f4f6; z-index: 2; }
    th.left { position: sticky; left: 0; z-index: 3; }
    td.left { position: sticky; left: 0; background: #f9fafb; z-index: 1; font-weight: 700; }

    .cell {
      width: 140px; height: 74px; border-radius: 8px; padding: 6px;
      display: flex; flex-direction: column; justify-content: center; gap: 2px;
      cursor: pointer; user-select: none;
      background: #ffffff;
    }
    .cell.empty { cursor: default; background: #fafafa; }

    /* VERDE FORÇADO para DONE */
    .cell.done { background: #e7f7ee !important; border: 1px solid #86efac !important; }
    .cell.done .st { color: #065f46; font-weight: 800; }

    .pos { font-size: 11px; color: #111827; font-weight: 700; }
    .cn  { font-weight: 800; font-size: 12px; color: #111827; }
    .iso { font-size: 11px; color: #6b7280; }
    .od  { font-size: 11px; color: #6b7280; }
    .wt  { font-size: 11px; color: #6b7280; }
    .st  { font-size: 11px; color: #6b7280; }
  </style>
</head>
<body>

  <div class="card">
    <h1 id="title">BayPlan</h1>

    <div class="row">
      <div>
        <label>API Base</label><br />
        <input id="apiBase" value="https://bayplan-1.onrender.com" style="width:260px" />
      </div>
      <div>
        <label>workset_id</label><br />
        <input id="worksetId" type="number" value="3" style="width:110px" />
      </div>
      <div style="display:flex; gap:8px; align-items:flex-end;">
        <button id="btnReload" class="active">Recarregar</button>
      </div>
    </div>

    <div class="section row">
      <button id="btnDISCHARGE" class="active">DISCHARGE</button>
      <button id="btnLOAD">LOAD</button>
    </div>

    <div class="section row">
      <button id="btnDECK">DECK</button>
      <button id="btnHOLD" class="active">HOLD</button>
    </div>

    <div class="section">
      <div class="row" id="bayButtons"></div>
      <div class="hint">
        Clique no container:
        <b>PENDING</b> → vira <b>DONE</b>.
        <b>DONE</b> → pergunta e faz <b>UNDONE</b>.
      </div>
    </div>

    <div id="status" class="status"></div>
    <div id="meta" class="meta"></div>
  </div>

  <div class="gridWrap">
    <table id="gridTable"></table>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  const state = {
    op: "DISCHARGE",
    area: "HOLD",
    bay: null,
    bayAreas: new Map(), // bay -> Set(areas)
    lastGrid: null
  };

  function setStatus(msg, isError=false) {
    const el = $("status");
    el.textContent = msg || "";
    el.className = "status" + (isError ? " error" : "");
  }

  function apiBase() {
    return ($("apiBase").value || "").replace(/\/+$/, "");
  }

  async function httpJson(url, options={}) {
    const res = await fetch(url, options);
    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch { /* ignore */ }
    if (!res.ok) {
      const msg = (data && (data.error || data.message)) ? (data.error || data.message) : text;
      throw new Error(msg || `HTTP ${res.status}`);
    }
    return data;
  }

  function setOp(op) {
    state.op = op;
    $("btnDISCHARGE").classList.toggle("active", op === "DISCHARGE");
    $("btnLOAD").classList.toggle("active", op === "LOAD");
  }

  function setArea(area) {
    state.area = area;
    $("btnDECK").classList.toggle("active", area === "DECK");
    $("btnHOLD").classList.toggle("active", area === "HOLD");
  }

  function setBay(bay) {
    state.bay = bay;
    document.querySelectorAll("#bayButtons button").forEach(b => b.classList.remove("active"));
    const btn = document.querySelector(`#bayButtons button[data-bay="${bay}"]`);
    if (btn) btn.classList.add("active");
  }

  function formatPos(bay, row, tier) {
    const b = String(Number(bay)).padStart(2, "0");
    const r = String(Number(row)).padStart(2, "0");
    const t = String(Number(tier)).padStart(2, "0");
    return `${b}${r}${t}`;
  }

  async function loadBays() {
    setStatus("Carregando bays...");
    const worksetId = Number($("worksetId").value);
    const url = `${apiBase()}/ops-bays?workset_id=${encodeURIComponent(worksetId)}&operation_type=${encodeURIComponent(state.op)}`;
    const data = await httpJson(url);

    state.bayAreas.clear();

    for (const it of (data.items || [])) {
      const bay = Number(it.bay);
      const area = String(it.area);
      if (!state.bayAreas.has(bay)) state.bayAreas.set(bay, new Set());
      state.bayAreas.get(bay).add(area);
    }

    const bays = Array.from(state.bayAreas.keys()).sort((a,b) => a-b);
    const wrap = $("bayButtons");
    wrap.innerHTML = "";

    if (bays.length === 0) {
      setStatus("Nenhuma bay com operação encontrada.", true);
      $("gridTable").innerHTML = "";
      $("meta").textContent = "";
      state.bay = null;
      return;
    }

    for (const bay of bays) {
      const btn = document.createElement("button");
      btn.className = "small";
      btn.textContent = `Bay ${bay}`;
      btn.dataset.bay = String(bay);

      btn.addEventListener("click", async () => {
        setBay(bay);

        const areas = state.bayAreas.get(bay) || new Set();
        if (!areas.has(state.area)) {
          if (areas.has("HOLD")) setArea("HOLD");
          else if (areas.has("DECK")) setArea("DECK");
        }
        await loadGrid();
      });

      wrap.appendChild(btn);
    }

    setBay(bays[0]);

    const a0 = state.bayAreas.get(bays[0]) || new Set();
    if (!a0.has(state.area)) {
      if (a0.has("HOLD")) setArea("HOLD");
      else if (a0.has("DECK")) setArea("DECK");
    }

    setStatus(`Bays carregadas: ${bays.length}.`);
  }

  async function loadGrid() {
    const worksetId = Number($("worksetId").value);
    const bay = Number(state.bay);
    const area = state.area;
    if (!worksetId || !bay || !area) return;

    setStatus(`Abrindo Bay ${bay} (${area})...`);

    const url = `${apiBase()}/baygrid?workset_id=${encodeURIComponent(worksetId)}&bay=${encodeURIComponent(bay)}&area=${encodeURIComponent(area)}`;
    const data = await httpJson(url);
    state.lastGrid = data;

    $("meta").innerHTML = `
      <b>Operação</b>: ${state.op} |
      <b>Bay</b>: ${data.bay} |
      <b>Área</b>: ${data.area} |
      <b>Containers</b>: ${data.stats?.containers ?? 0}
      ${Array.isArray(data.bay_group) ? `| <b>bay_group</b>: [${data.bay_group.join(", ")}]` : ""}
    `;

    renderTable(data);
    setStatus(`Bay ${bay} (${area}) carregada.`);
  }

  function buildCell(cellData) {
    const div = document.createElement("div");
    div.className = "cell";

    if (!cellData) {
      div.classList.add("empty");
      return div;
    }

    const pos = document.createElement("div");
    pos.className = "pos";
    pos.textContent = formatPos(cellData.bay, cellData.row, cellData.tier);

    const cn = document.createElement("div");
    cn.className = "cn";
    cn.textContent = cellData.container_no || "";

    const iso = document.createElement("div");
    iso.className = "iso";
    iso.textContent = cellData.iso_type || "";

    const od = document.createElement("div");
    od.className = "od";
    od.textContent = `OD: —`;

    const wt = document.createElement("div");
    wt.className = "wt";
    wt.textContent = `PESO: —`;

    const st = document.createElement("div");
    st.className = "st";
    st.textContent = cellData.status || "PENDING";

    div.appendChild(pos);
    div.appendChild(cn);
    div.appendChild(iso);
    div.appendChild(od);
    div.appendChild(wt);
    div.appendChild(st);

    if (cellData.status === "DONE") div.classList.add("done");

    return div;
  }

  function renderTable(data) {
    const rowsOrder = data.rows_order || [];
    const tiersOrder = data.tiers_order || [];
    const grid = data.grid || {};

    const table = $("gridTable");
    table.innerHTML = "";

    const thead = document.createElement("thead");
    const hr = document.createElement("tr");

    const th0 = document.createElement("th");
    th0.className = "left";
    th0.textContent = "TIER \\ ROW";
    hr.appendChild(th0);

    for (const r of rowsOrder) {
      const th = document.createElement("th");
      th.textContent = String(r).padStart(2, "0");
      hr.appendChild(th);
    }

    thead.appendChild(hr);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");

    for (const t of tiersOrder) {
      const tr = document.createElement("tr");

      const tdLeft = document.createElement("td");
      tdLeft.className = "left";
      tdLeft.textContent = String(t).padStart(2, "0");
      tr.appendChild(tdLeft);

      for (const r of rowsOrder) {
        const td = document.createElement("td");

        const cellData = (grid[String(r)] && grid[String(r)][String(t)]) ? grid[String(r)][String(t)] : null;
        const cell = buildCell(cellData);

        if (cellData && cellData.container_no) {
          cell.addEventListener("click", async () => {
            if (cellData.status === "DONE") {
              const ok = window.confirm(`Tem certeza que deseja fazer UNDONE do container ${cellData.container_no}?`);
              if (!ok) return;
              await markUndone(data.workset_id, cellData.container_no);
              await loadGrid();
              return;
            }

            await markDone(data.workset_id, cellData.container_no);
            await loadGrid();
          });
        }

        td.appendChild(cell);
        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    }

    table.appendChild(tbody);
  }

  async function markDone(worksetId, containerNo) {
    try {
      setStatus(`Marcando DONE: ${containerNo}...`);
      const url = `${apiBase()}/containers/done`;
      await httpJson(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ workset_id: worksetId, container_no: containerNo })
      });
      setStatus(`DONE: ${containerNo}`);
    } catch (e) {
      setStatus(`Erro ao marcar DONE: ${e.message}`, true);
    }
  }

  async function markUndone(worksetId, containerNo) {
    try {
      setStatus(`Fazendo UNDONE: ${containerNo}...`);
      const url = `${apiBase()}/containers/undone`;
      await httpJson(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ workset_id: worksetId, container_no: containerNo })
      });
      setStatus(`UNDONE: ${containerNo}`);
    } catch (e) {
      setStatus(`Erro ao fazer UNDONE: ${e.message}`, true);
    }
  }

  async function reloadAll() {
    try {
      setStatus("");
      $("gridTable").innerHTML = "";
      $("meta").textContent = "";
      await loadBays();
      await loadGrid();
    } catch (e) {
      setStatus(`Erro: ${e.message}`, true);
    }
  }

  $("btnReload").addEventListener("click", reloadAll);

  $("btnDISCHARGE").addEventListener("click", async () => { setOp("DISCHARGE"); await reloadAll(); });
  $("btnLOAD").addEventListener("click", async () => { setOp("LOAD"); await reloadAll(); });

  $("btnDECK").addEventListener("click", async () => { setArea("DECK"); await loadGrid(); });
  $("btnHOLD").addEventListener("click", async () => { setArea("HOLD"); await loadGrid(); });

  setOp("DISCHARGE");
  setArea("HOLD");
  reloadAll();
</script>

</body>
</html>
