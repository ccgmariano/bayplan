<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BayPlan</title>

<style>
body{margin:0;padding:12px;font-family:Arial;background:#f6f7f8}
.card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:12px}
h1{margin:0 0 8px 0;font-size:18px}
.section{margin-top:10px}
.row{display:flex;gap:8px;flex-wrap:wrap}
button{height:36px;padding:0 14px;border-radius:8px;border:1px solid #d1d5db;background:#fff;cursor:pointer}
button.active{background:#111827;color:#fff;border-color:#111827}
button.small{height:32px;font-size:13px}
.meta{font-size:12px;color:#374151;margin-top:6px}

.gridWrap{margin-top:12px;overflow:auto;border-radius:10px;border:1px solid #e5e7eb;background:#fff}
table{border-collapse:collapse;width:max-content;min-width:100%}
th,td{border:1px solid #e5e7eb;padding:6px;text-align:center}
th{position:sticky;top:0;background:#f3f4f6}
th.left,td.left{position:sticky;left:0;background:#f9fafb;font-weight:700}

.cell{width:112px;height:56px;border-radius:8px;padding:6px;display:flex;flex-direction:column;justify-content:center;cursor:pointer}
.cell.empty{background:#fafafa;cursor:default}
.cell.done{background:#e7f7ee}
.cn{font-weight:800;font-size:12px}
.iso,.st{font-size:11px;color:#6b7280}
.st.done{color:#065f46;font-weight:700}
</style>
</head>

<body>
<div class="card">
  <h1 id="vessel">BayPlan</h1>

  <!-- OPERAÇÃO -->
  <div class="section">
    <div class="row">
      <button id="btnDISCHARGE" class="active">DISCHARGE</button>
      <button id="btnLOAD">LOAD</button>
    </div>
  </div>

  <!-- BAYS -->
  <div class="section">
    <div class="row" id="bayButtons"></div>
  </div>

  <!-- ÁREA -->
  <div class="section">
    <div class="row">
      <button id="btnDECK">DECK</button>
      <button id="btnHOLD" class="active">HOLD</button>
    </div>
  </div>

  <div class="meta" id="meta"></div>
</div>

<div class="gridWrap">
  <table id="grid"></table>
</div>

<script>
const API = "https://bayplan-1.onrender.com";
const WORKSET_ID = 3;

let state = {
  op: "DISCHARGE",
  bay: null,
  area: "HOLD"
};

async function apiGet(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

// ---------------- OPS-BAYS ----------------
async function loadBays(){
  const data = await apiGet(`${API}/ops-bays?workset_id=${WORKSET_ID}&operation_type=${state.op}`);
  const wrap = document.getElementById("bayButtons");
  wrap.innerHTML = "";
  state.bay = null;

  data.items.forEach(it=>{
    const b = document.createElement("button");
    b.textContent = `Bay ${it.bay}`;
    b.className = "small";
    b.onclick = ()=>{
      document.querySelectorAll("#bayButtons button").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      state.bay = it.bay;
      loadGrid();
    };
    wrap.appendChild(b);
  });
}

// ---------------- GRID ----------------
async function loadGrid(){
  if(!state.bay) return;
  const d = await apiGet(`${API}/baygrid?workset_id=${WORKSET_ID}&bay=${state.bay}&area=${state.area}`);
  document.getElementById("meta").innerHTML =
    `Bay ${d.bay} (${d.area}) — Containers: ${d.stats.containers}`;

  renderGrid(d);
}

function renderGrid(d){
  const g = document.getElementById("grid");
  g.innerHTML = "";

  const thead = document.createElement("thead");
  const trh = document.createElement("tr");
  trh.innerHTML = `<th class="left">T\\R</th>` + d.rows_order.map(r=>`<th>${r}</th>`).join("");
  thead.appendChild(trh);
  g.appendChild(thead);

  const tb = document.createElement("tbody");
  d.tiers_order.forEach(t=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td class="left">${t}</td>`;
    d.rows_order.forEach(r=>{
      const c = d.grid[r]?.[t];
      const td = document.createElement("td");
      if(!c){
        td.innerHTML = `<div class="cell empty"></div>`;
      } else {
        td.innerHTML = `
          <div class="cell ${c.status==="DONE"?"done":""}">
            <div class="cn">${c.container_no}</div>
            <div class="iso">${c.iso_type}</div>
            <div class="st ${c.status==="DONE"?"done":""}">${c.status}</div>
          </div>`;
        td.onclick = async ()=>{
          if(c.status==="DONE") return;
          await fetch(`${API}/containers/done`,{
            method:"POST",
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({workset_id:WORKSET_ID,container_no:c.container_no})
          });
          loadGrid();
        };
      }
      tr.appendChild(td);
    });
    tb.appendChild(tr);
  });
  g.appendChild(tb);
}

// ---------------- CONTROLES ----------------
btnDISCHARGE.onclick = ()=>{
  btnDISCHARGE.classList.add("active");
  btnLOAD.classList.remove("active");
  state.op = "DISCHARGE";
  loadBays();
};

btnLOAD.onclick = ()=>{
  btnLOAD.classList.add("active");
  btnDISCHARGE.classList.remove("active");
  state.op = "LOAD";
  loadBays();
};

btnDECK.onclick = ()=>{
  btnDECK.classList.add("active");
  btnHOLD.classList.remove("active");
  state.area = "DECK";
  loadGrid();
};

btnHOLD.onclick = ()=>{
  btnHOLD.classList.add("active");
  btnDECK.classList.remove("active");
  state.area = "HOLD";
  loadGrid();
};

// INIT
loadBays();
</script>
</body>
</html>
